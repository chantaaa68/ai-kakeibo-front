<app-header></app-header>

<div class="category-detail-container">
  <!-- ページヘッダー -->
  <div class="page-header">
    <button mat-icon-button class="back-button" (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1 class="title">{{ allData()?.categoryName || 'レポート' }}</h1>
    <div class="spacer"></div>
  </div>

  <!-- ローディング -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>読み込み中...</p>
    </div>
  }

  <!-- エラー -->
  @else if (errorMessage()) {
    <div class="error-container">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <p>{{ errorMessage() }}</p>
      <button mat-raised-button class="retry-button" (click)="goBack()">戻る</button>
    </div>
  }

  <!-- メインコンテンツ -->
  @else if (allData()) {
    <!-- 合計金額カード -->
    <div class="summary-card">
      <div class="summary-label">{{ selectedMonthLabel() }} の合計</div>
      <div class="summary-amount">¥{{ formatAmount(selectedMonthTotal()) }}</div>
    </div>

    <!-- グラフエリア -->
    <div class="chart-container">
      <h2 class="section-title">月別推移</h2>
      <div class="chart-wrapper">
        <ngx-charts-bar-vertical
          [results]="displayedChartData()"
          [view]="view"
          [gradient]="false"
          [xAxis]="true"
          [yAxis]="true"
          [legend]="false"
          [showXAxisLabel]="false"
          [showYAxisLabel]="false"
          [animations]="true"
          [barPadding]="8"
          [roundEdges]="true"
          (select)="onSelect($event)">
        </ngx-charts-bar-vertical>
      </div>
      <p class="chart-hint">グラフをタップして月を選択できます</p>
    </div>

    <!-- 明細リスト -->
    <div class="transactions-container">
      <h2 class="section-title">{{ selectedMonthLabel() }} の明細</h2>

      @if (filteredTransactions().length === 0) {
        <div class="empty-state">
          <mat-icon class="empty-icon">receipt_long</mat-icon>
          <p>この月の取引はありません</p>
        </div>
      } @else {
        <div class="transaction-list">
          @for (transaction of filteredTransactions(); track transaction.id) {
            <div class="transaction-item">
              <div class="transaction-main">
                <div class="transaction-info">
                  <div class="transaction-name">{{ transaction.itemName }}</div>
                  <div class="transaction-date">{{ formatDate(transaction.usedDate) }}</div>
                </div>
                <div class="transaction-amount" [class.income]="transaction.inoutFlg">
                  {{ transaction.inoutFlg ? '+' : '-' }}¥{{ formatAmount(transaction.itemAmount) }}
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>
  }
</div>
